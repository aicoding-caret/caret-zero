// --- START: diff 유효성 검사 로직 추가 ---
const currentDiff = block.params.diff;
if (!currentDiff || typeof currentDiff !== 'string' || !currentDiff.includes("^SEARCH^") || !currentDiff.includes("^======^") || !currentDiff.includes("^REPLACE^")) {
    this.logger.error(`[presentAssistantMessage] Invalid or incomplete diff content for replace_in_file even though block.partial is false. Diff: ${currentDiff?.substring(0, 100)}...`);
    // 오류 처리: 사용자에게 알리고, 도구 결과로 오류를 반환하며, diff 뷰 정리
    await this.say("error", "Internal error processing file edit: Incomplete diff data received.");
    pushToolResult(formatResponse.toolError("Internal error: Incomplete or invalid diff data received for replace_in_file."));
    // diffViewProvider가 열려있을 수 있으므로 정리 시도
    if (this.diffViewProvider.isEditing) {
         await this.diffViewProvider.revertChanges();
         await this.diffViewProvider.reset();
    }
    break; // 현재 도구 처리 중단
}
// --- END: diff 유효성 검사 로직 추가 ---
