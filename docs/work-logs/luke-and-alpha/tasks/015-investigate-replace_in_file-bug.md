# 태스크 #015: `replace_in_file` 도구 버그 조사

## 담당자
*   루크 (마스터)
*   알파 (AI)

## 목표
`replace_in_file` 도구가 특정 조건(특히 여러 줄로 구성된 복잡한 블록 삭제 시)에서 성공 메시지를 반환함에도 불구하고 실제 파일 내용을 수정하지 못하는 버그의 원인을 파악하고 해결합니다.

## 배경
2025-04-08 시스템 프롬프트 개선 보고서 작업 중, `replace_in_file` 도구를 사용하여 보고서 내 특정 섹션(여러 줄 JSON 블록 및 관련 설명)을 삭제하려고 시도했으나, 도구는 성공 메시지를 반환했음에도 불구하고 실제 파일 내용은 변경되지 않는 현상이 반복적으로 관찰되었습니다. 간단한 한 줄 텍스트 교체는 성공하는 것으로 보아, 복잡한 멀티라인 `SEARCH/REPLACE` 작업에서 문제가 발생하는 것으로 추정됩니다.

## 세부 작업
1.  **재현 테스트:** 다양한 종류의 멀티라인 `SEARCH/REPLACE` 시나리오(삭제, 수정 등)를 통해 `replace_in_file` 도구의 버그를 안정적으로 재현합니다.
2.  **원인 분석:**
    *   `replace_in_file` 도구의 내부 로직 검토 (관련 소스 코드 확인 필요).
    *   `SEARCH` 블록의 정확성, 공백/개행 문자 처리 방식 등 확인.
    *   파일 인코딩 또는 운영체제별 차이점 가능성 검토.
    *   도구 실행 환경 또는 의존성 문제 가능성 검토.
3.  **버그 수정:** 분석된 원인을 바탕으로 `replace_in_file` 도구의 코드를 수정합니다.
4.  **검증:** 수정된 도구를 사용하여 이전에 실패했던 시나리오 및 다양한 테스트 케이스를 실행하여 버그가 해결되었는지 확인합니다.
5.  **문서화:** 발견된 버그의 원인과 해결 과정을 기록합니다.

## 예상 결과물
*   수정된 `replace_in_file` 도구 코드.
*   버그 재현 및 해결 검증 테스트 케이스.
*   버그 분석 및 해결 과정 문서.

## 우선순위
*   높음 (AI의 파일 수정 능력에 직접적인 영향을 미치는 핵심 도구 버그)

## 분석 내용

1.  **도구 진입점:** `replace_in_file` 도구는 `src/core/task/index.ts` 파일의 `Task` 클래스 내에서 호출됩니다.

    *   `Task.recursivelyMakeClineRequests` 함수에서 `block.name === "replace_in_file"` 조건에 따라 `replace_in_file` 도구 로직이 실행됩니다.
    *   이때, `block.params.path`에서 파일 경로를 가져오고, `block.params.diff`에서 `diff` 내용을 가져옵니다.
    *   `constructNewFileContent` 함수를 호출하여 새로운 파일 내용을 생성하고, `diffViewProvider`를 사용하여 diff 에디터를 업데이트합니다.
    *   마지막으로, `diffViewProvider.saveChanges()`를 호출하여 파일에 변경 사항을 저장합니다.

2.  **문제 발생 가능 지점 및 해결 아이디어:**

    *   **`constructNewFileContent` 함수:**
        *   **문제:** 여러 줄 블록 삭제 시, 줄 바꿈 문자 처리 또는 정규 표현식 문제로 인해 `SEARCH` 블록과 일치하는 부분을 찾지 못할 수 있습니다.
        *   **해결 아이디어:**
            *   `constructNewFileContent` 함수 내에서 줄 바꿈 문자 처리 로직을 개선합니다. 예를 들어, `\r\n`, `\n` 등 다양한 줄 바꿈 문자를 모두 인식하고 처리할 수 있도록 합니다.
            *   `SEARCH` 블록에 정규 표현식이 포함된 경우, 정규 표현식을 안전하게 처리할 수 있도록 합니다.
        *   **문제:** 파일 시스템 권한 문제, 파일 잠금 문제, 디스크 공간 부족 문제 등으로 인해 파일 저장이 실패할 수 있습니다.
        *   **해결 아이디어:**
            *   `diffViewProvider.saveChanges()` 함수 내에서 파일 저장 시 예외 처리 로직을 강화합니다.
            *   파일 저장 실패 시, 사용자에게 오류 메시지를 표시하고 재시도 옵션을 제공합니다.
            *   파일 저장 전에 파일 시스템 상태를 확인하여 문제가 발생할 가능성을 미리 감지합니다.
    *   **전체 흐름:**
        *   **문제:** `replace_in_file` 도구가 성공 메시지를 반환했지만, 실제 파일 내용은 수정되지 않은 경우, 오류가 제대로 처리되지 않았을 가능성이 있습니다.
        *   **해결 아이디어:**
            *   `replace_in_file` 도구 전체 로직에서 오류 처리 로직을 강화합니다.
            *   각 단계에서 예외가 발생하는 경우, 오류 메시지를 표시하고 도구 실행을 중단합니다.
            *   파일 수정 후, 파일 내용을 다시 읽어와 실제로 수정되었는지 확인합니다.

## 다음 단계

1.  **버그 재현 테스트를 위한 시나리오 준비:**
    *   `docs/work-logs/luke-and-alpha/reports/rules/final_rule_proposal_report.md` 파일을 수정하여 여러 줄로 구성된 JSON 블록을 추가합니다.
    *   `replace_in_file` 도구를 사용하여 해당 JSON 블록을 삭제하는 `diffContent`를 생성합니다.
    *   `replace_in_file` 도구를 실행하고, 파일이 실제로 수정되지 않는지 확인합니다.
2.  **`constructNewFileContent` 함수 및 `diffViewProvider.saveChanges()` 함수 분석 및 디버깅:**
    *   위에서 제시된 해결 아이디어를 바탕으로 코드를 분석하고, 디버깅을 통해 버그 원인을 파악합니다.
