# Caret: Cline 업스트림 병합 가이드 (서브 레파지토리 방식)

**작성자**: Alpha Yang
**목적**: `cline` 원본 저장소의 최신 변경 사항을 `caret-zero` 프로젝트의 `cline` 서브 레파지토리에 안전하게 병합하는 절차를 안내합니다.

---

## 1. 아키텍처 이해: 중첩된 서브 레파지토리 (Nested Sub-Repository)

`caret-zero`는 `cline`을 프로젝트 내부에 별도의 독립된 Git 저장소로 포함하는 **서브 레파지토리** 구조를 사용합니다.

- **`caret-zero/` (메인 저장소)**: `Caret`의 고유 기능, 오버레이 로직, 최종 빌드 설정 등을 관리하는 메인 프로젝트입니다.
- **`caret-zero/cline/` (서브 레파지토리)**: `cline` 원본 프로젝트를 그대로 클론한, 독립적인 Git 저장소입니다. 이 디렉토리 내부는 그 자체로 완전한 `cline` 프로젝트입니다.

### 📜 **핵심 원칙: `cline` 디렉토리 직접 수정 금지**

`cline` 디렉토리의 코드는 `cline` 원본 저장소와의 연결을 유지하기 위해 **절대 직접 수정하지 않는 것을 원칙**으로 합니다. 이는 병합을 단순화하고, `cline`의 변경 내역을 명확하게 추적하기 위함입니다. 필요한 기능 변경이나 확장은 `caret/` 또는 `src/` 디렉토리에서 `cline`의 기능을 래핑하거나 오버라이드하는 방식으로 구현해야 합니다.

(단, 아래 '문제 해결' 섹션에서 설명하는 빌드 환경 호환성 문제와 같은 예외적인 경우는 제외합니다.)

---

## 2. 병합 절차 (Step-by-Step)

### 2.1. `cline` 디렉토리로 이동

먼저, `caret-zero` 프로젝트 루트에서 `cline` 서브 레파지토리 디렉토리로 이동합니다.

```bash
cd cline
```

### 2.2. Upstream 변경 사항 가져오기 (`git pull`)

`cline` 디렉토리 안에서 `git pull` 명령을 사용하여 원본 저장소(`origin`, 즉 `cline/cline`)의 최신 변경 사항을 가져옵니다. `main` 브랜치를 기준으로 합니다.

```bash
# 현재 브랜치가 main이라고 가정
git pull origin main
```

> **참고:** `cline` 저장소의 원격(`remote`) 설정이 궁금하다면 `git remote -v` 명령어로 확인할 수 있습니다. `origin`이 `https://github.com/cline/cline.git`를 가리켜야 합니다.

### 2.3. 메인 프로젝트로 복귀

`cline`의 업데이트가 완료되면, 다시 `caret-zero` 루트 디렉토리로 돌아옵니다.

```bash
cd ..
```

---

## 3. 빌드 및 검증

`cline`이 업데이트되었으므로, `caret-zero` 프로젝트 전체에 변경 사항이 영향을 줄 수 있습니다. 반드시 전체 빌드와 테스트를 통해 호환성을 검증해야 합니다.

```bash
# 1. 의존성 재설치 (최상위 루트에서 실행)
# cline의 package.json 변경에 따른 의존성 업데이트를 위해 필수
npm install

# 2. 전체 프로젝트 컴파일
npm run compile

# 3. 전체 테스트 실행
npm run test
```

이 과정에서 발생하는 대부분의 오류는 `caret/`나 `src/`에서 `cline`의 변경된 코드를 사용하다가 발생하는 호환성 문제입니다. **오류가 발생한 `caret` 측 코드를 수정**하여 해결해야 하며, `cline` 코드를 직접 수정해서는 안 됩니다.

---

## 4. 문제 해결 (Troubleshooting)

`cline`을 병합하는 과정에서 발생할 수 있는 잠재적인 문제들과 해결 방안입니다.

### 4.1. Caret의 패치/오버라이드 전략 및 사후 관리

**핵심은 `cline`을 직접 수정하지 않되, 필요한 부분은 `Caret`에서 제어 가능하도록 만드는 것입니다.**

-   **전략**: 대부분의 기능은 `src/` 디렉토리에서 `cline` 모듈을 가져와 래핑(wrapping)하거나 확장하여 구현합니다. 하지만 빌드 스크립트나 환경 설정처럼 래핑만으로 해결하기 어려운 경우가 있습니다. 이럴 때 예외적으로 `cline` 디렉토리 내부의 특정 파일을 `Caret` 프로젝트에 미리 준비해 둔 파일로 **덮어쓰는(Patch/Override)** 전략을 사용합니다.

-   **중요성**: 이 방식은 `cline`의 코어 동작을 `Caret`에 맞게 조정할 수 있는 강력한 방법이지만, **업스트림(`cline` 원본) 병합 시 각별한 주의가 필요합니다.** `git pull`을 실행하면 우리가 덮어쓴 파일들이 `cline`의 최신 버전으로 다시 원복될 수 있기 때문입니다.

-   **사후 관리 체크리스트**: `cline` 디렉토리에서 `git pull`을 완료한 후, 메인 프로젝트에서 빌드/테스트를 진행하기 전에 반드시 다음을 확인해야 합니다.
    1.  아래 **패치 목록**에 있는 파일들이 `cline`의 최신 커밋에서 변경되었는지 확인합니다. (`git log -p -- cline/해당파일경로`)
    2.  만약 원본 파일이 변경되었다면, `Caret`이 적용했던 패치가 여전히 유효한지, 아니면 새로운 원본 파일 내용에 맞게 `Caret`의 패치 파일(`docs/development/resources/` 안의 파일)을 수정해야 하는지 검토해야 합니다.
    3.  검토가 끝나면, `Caret`의 패치 파일을 다시 `cline`의 대상 경로로 복사하여 덮어씁니다.

#### **알려진 패치 목록**

1.  **Windows `protoc` 빌드 호환성 패치**
    -   **대상 파일**: `cline/proto/build-proto.js`
    -   **패치 파일**: `src/patch/build-proto.js`
    -   **대상 폴더**: `cline/proto/protoc-31.0-win64`
    -   **패치 폴더**: `src/patch/protoc-31.0-win64`
    -   **사유**: `cline`이 사용하는 `grpc-tools`의 `protoc` 바이너리가 특정 Windows 환경과 호환되지 않는 문제를 해결하기 위함입니다.
    -   **조치 방법**: `README.md`의 [Windows 환경 설정](./README.md#3-windows-environment-setup-conditional) 섹션을 참고하여 파일을 복사합니다.

### 4.2. 일반적인 빌드/테스트 오류

`cline`의 인터페이스나 로직 변경으로 인해 `Caret`의 래핑 코드에서 발생하는 호환성 문제입니다.

-   **해결 방안**: 오류 메시지를 분석하여 `src/` 또는 `caret/` 디렉토리 내에서 `cline`의 변경된 부분을 사용하는 코드를 찾아 수정합니다. **이 경우, `cline` 코드를 직접 수정하는 것이 아니라, `Caret` 코드를 수정해야 합니다.** 